# geohash、google s2、uber h3三种格网系统比较（2） - 掘金
接前序文章：geohash、google s2、uber h3三种格网系统比较（1）
------------------------------------------

3 平面多边形编码
---------

\*\*\*\*对平面内铺满多边形后，则需要对每个多边形进行特殊位置进行编码以确定每个编码的特定位置。**对多边形进行编码实质上是一种降维的策略，是将平面二维的数据转换成了一维的线性数据，以方便对平面数据进行编码、计算、索引等的操作。** 

**在表征一个多边形的四个格子时，如用平面坐标系，则为（1，-1），（1，1），（-1，-1），（-1，1），对于二维数据无论是存储、计算、排序都是相对较为困难的。将二维数据转换为一维数据后则可以复用一维数据的存储、排序等能力，对于一种能填充满一个平面的空间曲线则可以将二维平面转换为一维曲线。这种曲线称之为空间填充曲线。如下图的z字形曲线，将平面表征为0，1，2，3。** 

**上述每种格子编码系统使用的空间填充曲线都不同，这种空间填充曲线选择上的不同也会造成每种编码系统特性的不同。** 

*   **geohash，使用了z字型**曲线**编码**
*   **google s2使用了hillebert曲线编码**
*   **uber h3使用了Gosper曲线编码**

**（1）geohash**

**上文说到geohash用了墨卡托投影，将投影后的地图进行矩形分区，对各个分区的格子进行编码，再对划分后的格子进行同样的的四分和编码，不断的向下分级，最终形成一个二进制的编码，再用base32算法，每五位形成一个编码表示出来。即可形成geohash。** 

\*\*![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/9060d6a4cf2b4899ac52715a98201398~tplv-k3u1fbpfcp-zoom-in-crop-mark:3024:0:0:0.awebp)
  
\*\*

**使用z曲线编码是比较简单的，但z曲线也有其固有的弱点，在判断两个格子的临近关系时，若仅通过geohash编码来判断，则有可能会出现编码相近而距离较远的情况。如上图右二，0111和1000两个格子，编码相近，但是由于z字形的突变，导致距离是远的，这就给部分距离判断带来了困难，在距离突变的情况下，编码相邻但距离较远。除此之外，由于geohash是每五位一编码，因此二进制编码的长度只能五的倍数，因此在编码的时候，geohash相邻级别并非是四分的下一个级别。因此造成了两个geohash级别之间的面积等差异较大，针对这种情况，也有算法对geohash做改良，使geohash的每个相邻的级别之间都是四分的下一个级别。** 

**（2）google s2**

\*\*google s2所用的\*\*\*\*希尔伯特曲线是另外一种比较常见的填充曲线。这种曲线克服了z字形曲线编码突变的问题，每个相邻的编码其实际距离都是相近的。\*\***其构造方式是把前一阶的曲线复制四份，将左下角和右下角的曲线做一个沿对角线的翻转，然后增加三条线段把这四份连起来。这些曲线的极限就是希尔伯特曲线。这种填充曲线的编码方式要比z字形曲线复杂一些，同时还需要涉及翻转等的操作，编码的难度较z字形大。** 

\*\*![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/d54172c9dfe64cee8cdbe680359142cf~tplv-k3u1fbpfcp-zoom-in-crop-mark:3024:0:0:0.awebp)
  
\*\*

**在编码的过程中，google s2的CellID 是64位的，前三位保存六边形的面编号，最后一位是标志位，中间的60位保存相应的编码信息。** 

\*\*\*\*\*\*（3）**uber h3**  
\*\*

\*\*\*\*由于六边形的特殊性，uber h3采用了\*\*\*\*****Gosper曲线进行编码。gosper曲线同样有希尔伯特******曲线的特性，次序相近的两节点，其距离一般也相近。编码方式也和google s2类似。** 

![](https://www.researchgate.net/publication/333438802/figure/fig1/AS:763718157750275@1559096006161/Row-1-Three-iterations-of-the-Gosper-curve-Row-2-Tiling-with-Gosper-islands-Seven.png)

对于曲线的选择方面，根据相邻相近的特性，Gopser = Hilbert > Geohash

4 使用场景推荐
--------

在格子应用在某个业务的时候，需要考虑格子使用的场景，具体场景具体分析，选择合适的格子系统：

格子使用的级别是固定的嘛？需要考虑到格子的面积大小和变形状况嘛？需要计算格子和格子之间相互关系（如临近关系）嘛？需要多级格子，使用上层级别查询到下层级别嘛？

考虑最简单的场景

**查找附近的人：** ![](https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/3a484471b93942bcb35b4e6a7a516d62~tplv-k3u1fbpfcp-zoom-in-crop-mark:3024:0:0:0.awebp?)

这个问题抽象成给定一个中心点，查找附近的点(这里只讨论使用格子索引的方案，其他树形索引不在此讨论）

你需要考虑的业务方面的需求比如：

（1）查找的范围固定嘛

a）查找的范围固定：比如3km（典型场景：地图里查找3km范围内的商家）

b）查找范围不固定

（2）查找的距离需要很精确吗

a)精确：严格查找3km范围内的

b)不精确：多点少点问题不大，基本准确就行

（3）形状是啥

a）圆形

b）矩形

c）任意形状

对于**1a**这个情况来说，选一个固定的格子级别进行计算就行，考虑**问题3**推荐使用更贴合形状的格子系统进行使用；![](https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/0bbde93314e74a0e9d7235179a539071~tplv-k3u1fbpfcp-zoom-in-crop-mark:3024:0:0:0.awebp?)

比如圆形，使用六边形是比矩形更好的选择，查询会更精确。

考虑\*\*问题2，\*\*无论需要精确或者不精确，使用贴合格子都会减少一些计算量。

对于**1b**这个场景来说，需要考虑的情况又不同。

需要考虑这个范围相差大吗，如果相差大，单一级别格子肯定是不够用的，100km的范围用1m边长的格子需要非常多数量，100m范围用10km边长的格子会筛选出来非常多的错误结果，需要用到多级格子的情况。

使用多级格子对一个范围进行覆盖时，google s2是一个比较好的解决方案（完美覆盖、级别多），geohash次之，uber h3由于在多级情况下，并不能完美覆盖，所以在使用中不太理想。

使用的级别越多，覆盖越好，但存储格子的数量会越大，多一个级别都是成倍数的格子增长。考虑**问题2**，如果查询是精确的，使用更多级格子可以相对精确的进行匹配，如果不精确，那么使用少级别的格子也是可行的。

![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/8131fc62c9df45acbda79f675547a0a2~tplv-k3u1fbpfcp-zoom-in-crop-mark:3024:0:0:0.awebp)
![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/4d125bddb2fb4d79ac50a6fb8bb6aeb1~tplv-k3u1fbpfcp-zoom-in-crop-mark:3024:0:0:0.awebp)

其实使用格子的场景有非常多种，考虑的维度不同，选用的格子系统就不同。在一些特殊的领域比如热力图大多数选择的都是六边形。在使用格子时，更重要的是应该根据自己的业务情况进行选择，没有一种格子是完美的，能横向比较，选择最适用于业务才是更好的方式。